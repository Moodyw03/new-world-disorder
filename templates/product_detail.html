<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css" integrity="sha512-tS3S5qG0BlhnQROyJXvNjeEM4UpMXHrQfTGmbQ1gKmelCxlSEBUaxhRBj/EFTzpbP4RVSrpEikbmdJobCvhE3g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css" integrity="sha512-sMXtMNL1zRzolHYKEujM2AqCLUR9F2C4/05cdbxjjLSRvMQIciEPCQZo++nk7go3BtSuK9kfa/s+a4f4i5pLkw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<style>
.centered {
    position: fixed;
    top: 50%; /* Keep centered vertically */
    left: 50%; /* Centered horizontally on large screens */
    transform: translate(-50%, -50%);
    
    padding: 20px;
}

/* Media query for small screens */
@media (max-width: 768px) { /* Adjust the max-width as needed for your breakpoint */
    .centered {
        left: 30%; /* Align to the left */
        top: 50%; /* Keep centered vertically */
        transform: translate(0, -50%); /* Remove horizontal centering */
        
    }
}
@media (max-width: 820px) { /* Adjust the max-width as needed for your breakpoint */
    .centered {
        left: 30%; /* Align to the left */
        top: 50%; /* Keep centered vertically */
        transform: translate(0, -50%); /* Remove horizontal centering */
        
    }
}
@media (max-width: 390px) { /* Adjust the max-width as needed for your breakpoint */
    .centered {
        left: 10%; /* Align to the left */
        top: 60%; /* Keep centered vertically */
        transform: translate(0, -50%); /* Remove horizontal centering */
        width: 10px;
        
    }
}
@media (max-width: 430px) { /* Adjust the max-width as needed for your breakpoint */
    .centered {
        left: 10%; /* Align to the left */
        top: 60%; /* Keep centered vertically */
        transform: translate(0, -50%); /* Remove horizontal centering */
        width: 10px;
        
    }
}
.centered2{
    position:fixed;
     top:40%;
      left:37vh;
      width:300px;
}
@media (max-width: 768px) { /* Adjust the max-width as needed for your breakpoint */
    .centered2 {
        position:fixed;
        left:35vh;
        top:17vh ;
        width:250px;
    }
}

@media (max-width: 390px) { /* Adjust the max-width as needed for your breakpoint */
    .centered2 {
        position:fixed;
        left:10vh;
        top:22vh ;
        width:250px;
    }
}
@media (max-width: 430px) { /* Adjust the max-width as needed for your breakpoint */
    .centered2 {
        position:fixed;
        left:10vh;
        top:22vh ;
        width:250px;
    }
}
.shiny-btn {
    padding: 10px 20px;
    font-size: 16px;
    color: #fff;
    background: linear-gradient(45deg, #007BFF, #8811AA);
    border: none;
    border-radius: 5px;
    cursor: pointer;
    outline: none;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
}

.shiny-btn:hover {
    background: linear-gradient(45deg, #006BEE, #7701AA);
    box-shadow: 0 0 10px #007BFF, 0 0 40px #007BFF, 0 0 80px #007BFF;
    transition-delay: 0.1s;
}

.shiny-btn:before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(120deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: all 0.7s ease;
}

.shiny-btn:hover:before {
    left: 100%;
}

.shiny-btn:focus {
    outline: none;
}
/* Media query for extra small screens */


</style>
<body>
 <!-- product_detail.html -->


 <nav class="navbar navbar-expand-lg navbar-light ">
    <div class="container p-4">
        <a class="navbar-brand"href="{% url 'list_printful_products' %}" style="font-weight: bolder;  text-shadow: 1px 1px white; color: beige; " > <h2> New World Disorder EST.2024 </h2> </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div class="navbar-nav ms-auto">
                <a class="nav-link active  " href="{% url 'list_printful_products' %}" style="margin-top: 10px; color: beige; ">Home</a>
                <a class="nav-link lg:mr-2 " href="{% url 'profile' %} " style="cursor: pointer;margin-top: 10px; color: beige; ">  Contact Us </a>
                <a class="nav-link lg:mr-2 " href="{% url 'register' %}"  > <button class="custom-button" > Sign up</button> </a>
                <a class="nav-link lg:mr-2 " href="{% url 'ch_page' %}"  > <button class="cartb" > <i class="fa-solid fa-cart-plus fa-xl" style="color: #fbfaff;"></i></button> </a>
                
                
            </div>
        </div>
    </div>
</nav>

{% if request.user.is_authenticated %}
<div style=" max-width: fit-content; padding:10px ; height: 90vh;   " >
<div id="username-display">
    <strong>Username:</stron>   <i> {{ user.username }} </i> <button  onclick="toggleEdit('username')" >Edit</button>

</div>
<div id="username-edit" style="display:none">
    <label for="username">Username:</label>
    <input type="text" id="username" name="username" value="{{ user.username }}">
</div>

<div id="email-display">
    <strong>Email:</strong> <i> {{ user.email }} </i> <button onclick="toggleEdit('email')">Edit</button>
</div>
<div id="email-edit" style="display:none">
    <label for="email">Email:</label> 
    <input type="text" id="email" name="email" value="{{ user.email }}">
</div>

<button onclick="saveChanges()" style="margin: 5px;" class="shiny-btn" >Save Changes</button>

    <form action="{% url 'logout' %}" method="post">
        {% csrf_token %}
        <button type="submit" style="margin: 5px;" class="shiny-btn" >Logout</button>
    </form>
</div>
{% endif %}

<div class="centered" >
    <div class="text-center p-2" style="border: 2px solid black; display: inline-block;">
        <img id="productImage" src="{{ product.thumbnail_url }}" alt="Product Image" style="max-width: 200px; max-height:200px;">
        <h2 style="text-align: center;">{{ product.name }}</h2>
        <h3 id="productPrice">Price: {{variant.price}}</h3>
        <p>Select any Sizes with any Color:</p>
        <select id="variantSelector" onchange="updateVariantDetails(); enableOrderButton(); showNewButton(); checkEnter();">
            {% for variant in product.variants %}
            <option value="{{ variant.variant_id }}" data-img="{{ variant.product.image }}" data-price="{{ variant.retail_price }} {{ variant.currency }}">
                {{ variant.color }} - {{ variant.size }}
            </option>
            {% endfor %}
        </select> <br>
        
        <button id="newButton" onclick="displaySelectedVariantDetails();" style="display: none; margin-top: 5px;" class="shiny-btn">New Button</button>
        
       
        <button id="orderButton" onclick="document.getElementById('orderForm').style.display='block'" style="margin-top: 5px;" class="shiny-btn" disabled>Order Now</button>
        


    </div>

<!-- The card for collecting recipient information -->
<div id="orderForm"  class="m-5 p-4 centered2 " style="display:none;  transform:translate(-50%, -50%); background:white;  box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);   max-height:fit-content ; border-radius:5px;">
    <h4 class="p-1" style="display:inline-block ; white-space: nowrap; " > Shipping Information</h4>
    <input type="text" id="name" placeholder="Name" required class="form-control mb-2 " >
    <input type="text" id="address1" placeholder="Address" required class="form-control mb-2 " >
    <select id="country" required style="width: 18vh;"class="form-select mb-2 " ><option value="">Select Country</option></select>
   <input type="text" id="city" placeholder="City" required class="form-control mb-2 " >
   <select id="state" required class="form-select mb-2 " ><option value="">Select State</option></select>
    <input type="text" id="zip" placeholder="ZIP Code"  class="form-control mb-2 " required>
    {% if request.user.is_authenticated %}
    <button onclick="placePrintfulOrder()" class="btn btn-outline-secondary" >Place Order</button>
{% else %}
    <button onclick="location.href='{% url 'login' %}'" class="btn btn-outline-secondary mt-1 " >Log In to Place Order</button>
{% endif %}
    <button onclick="document.getElementById('orderForm').style.display='none'" class="btn btn-outline-secondary mt-1 " >Cancel</button>
</div>
</div>
<!-- Button to show the order form -->








<div class="container-fluid bg-dark  text-center fixed-bottom "> <p class="text-white pt-1 " > @New World Disorder EST 2024. All right reserved </p> </div>
<script>






// var selectedVariants = JSON.parse(localStorage.getItem('selectedVariants') || '[]');

// function updateVariantDetails() {
//     var selector = document.getElementById('variantSelector');
//     var selectedOption = selector.options[selector.selectedIndex];
//     var imgSrc = selectedOption.getAttribute('data-img');
//     var price = selectedOption.getAttribute('data-price');
//     var variantId = selectedOption.value;

//     // Update the product image and price display
//     document.getElementById('productImage').src = imgSrc;
//     document.getElementById('productPrice').textContent = 'Price: ' + price;
// }

// function showNewButton() {
//     document.getElementById('newButton').style.display = 'inline-block'; // Make the New Button visible
// }

// function displaySelectedVariantDetails() {
//     var selector = document.getElementById('variantSelector');
//     var selectedOption = selector.options[selector.selectedIndex];
//     var imgSrc = selectedOption.getAttribute('data-img');
//     var price = selectedOption.getAttribute('data-price');
//     var variantId = selectedOption.value;

//     var currentSelection = { variantId, imgSrc, price }; // Create object for the new selection
//     selectedVariants.push(currentSelection); // Add to array

//     localStorage.setItem('selectedVariants', JSON.stringify(selectedVariants)); // Update localStorage
//     appendVariantToContainer(currentSelection, selectedVariants.length - 1); // Display the new selection
// }

// function appendVariantToContainer(variant, index) {
//     var container = document.getElementById('selectedVariantsContainer');
//     var variantDisplay = document.createElement('div');
//     variantDisplay.setAttribute('id', `variant-${index}`);
//     variantDisplay.innerHTML = `
//         <img src="${variant.imgSrc}" alt="Variant Image" style="width: 50px; height: 50px;">
//         <p>Price: ${variant.price}</p>
//         <button onclick="deleteVariant(${index})">Delete</button>
//     `;
//     container.appendChild(variantDisplay);
// }

// function deleteVariant(index) {
//     selectedVariants.splice(index, 1); // Remove variant
//     localStorage.setItem('selectedVariants', JSON.stringify(selectedVariants)); // Update localStorage
//     refreshVariantsDisplay(); // Refresh display
// }

// function refreshVariantsDisplay() {
//     var container = document.getElementById('selectedVariantsContainer');
//     container.innerHTML = ''; // Clear display
//     selectedVariants.forEach((variant, index) => {
//         appendVariantToContainer(variant, index); // Re-append each variant
//     });
// }

// // Display variants from localStorage on page load
// document.addEventListener('DOMContentLoaded', function() {
//     refreshVariantsDisplay();
// });


// Add this function to handle the Enter key press
function checkEnter(event) {
    if (event.key === 'Enter') {
        var selectElement = document.getElementById('variantSelector');
        var selectedOption = selectElement.options[selectElement.selectedIndex];

        if (selectedOption.value === '') {
            alert('Please select any product.');
            event.preventDefault(); // Prevent form submission or other default behavior
        }
    }
}


function enableOrderButton() {
        document.getElementById('orderButton').disabled = false;
    }
function placePrintfulOrder() {
    var country=document.getElementById("country");
    var state=document.getElementById('state');
    // Gather recipient details
    const recipient = {
        name: document.getElementById('name').value,
        address1: document.getElementById('address1').value,
        country: country.options[country.selectedIndex].text,
        city: document.getElementById('city').value,
        state:state.options[state.selectedIndex].text,
        state_code: document.getElementById('state').value,
        country_code: document.getElementById('country').value,
        zip: document.getElementById('zip').value
    };
//item detail
const items = [
  {
    variant_id: selectedVariantId.toString(),
    quantity: "1",
    image_url: selectedImageUrl, // Assuming this is a global variable set elsewhere
    files: [
      {
        url: "https://www.example.com/files/tshirts/example.png",
        type: "default",
        options: [
          {
            id: "template_type",
            value: "native"
          }
        ]
      }
    ]
  }
];
 // Details of the order
    const orderDetails = {
        recipient: recipient, // Including the recipient object
        items:items,
      
    };

    console.log("Order Details:", orderDetails);

    // Sending the AJAX request
    fetch('/place-order/', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        // Include other necessary headers
    },
    body: JSON.stringify(orderDetails),
})
.then(response => {
    if (!response.ok) {
        return response.json().then(error => Promise.reject(error));
    }
    return response.json();
})
.then(data => {
    alert("Order successful:", data);

})
.catch(error => {
    alert.error("Order error:", error);
});

}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}


// {% comment %} for the user porofile {% endcomment %}
function saveChanges() {
    // Implement AJAX request to send updated information to Django
    const username = document.getElementById('username').value;
    const email = document.getElementById('email').value;
    
    fetch('/path/to/update-profile/', { // Update this path to your Django view
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({username, email})
    }).then(response => response.json())
    .then(data => {
        console.log('Success:', data);
        // Optionally refresh the page or update the display fields with the new values
        window.location.reload(); // Simple way to refresh and show the updated info
    })
    .catch((error) => {
        console.error('Error:', error);
    });
}

function enableOrderButton() {
    var selectElement = document.getElementById('variantSelector');
    var orderButton = document.getElementById('orderButton');

    if (selectElement.value !== '') {
        orderButton.removeAttribute('disabled');
        selectElement.style.cursor = 'auto'; // Change cursor style to default
    } else {
        orderButton.setAttribute('disabled', 'disabled');
        document.getElementById('orderButton').style.cursor = 'none'; // Change cursor style to not-allowed
    }
}

function toggleEdit(fieldName) {
    const displayDiv = document.getElementById(fieldName + '-display');
    const editDiv = document.getElementById(fieldName + '-edit');
    displayDiv.style.display = displayDiv.style.display === 'none' ? 'block' : 'none';
    editDiv.style.display = editDiv.style.display === 'block' ? 'none' : 'block';
}
// {% comment %} For API of country and states {% endcomment %}
$(document).ready(function() {
    // Assume countriesData is loaded with the full data including states (and possibly ZIP codes)
    var countriesData;

    // Initially fetch countries (and their states)
    $.getJSON('/api/proxy/countries/', function(response) {
        if (response.code === 200 && Array.isArray(response.result)) {
            countriesData = response.result; // Store the fetched data
            response.result.forEach(function(country) {
                $('#country').append($('<option>', {
                    value: country.code,
                    text: country.name
                }));
            });
        } else {
            console.error("Unexpected data structure or error code:", response);
        }
    });

    // When a country is selected, populate states from preloaded data
    $('#country').change(function() {
        var countryCode = $(this).val(); // Get the selected country code
        var selectedCountry = countriesData.find(country => country.code === countryCode);

        $('#state').empty().append('<option value="">Select State</option>'); // Reset state dropdown
        $('#zip_dropdown').empty(); // Potentially clear ZIP code dropdown

        // Populate states dropdown
        if (selectedCountry && Array.isArray(selectedCountry.states)) {
            selectedCountry.states.forEach(function(state) {
                $('#state').append($('<option>', {
                    value: state.code,
                    text: state.name
                      
                }));
            });
        }
    });
});

//     // Optionally handle state change to populate ZIP codes, if ZIP code data is available and structured accordingly
//     // This part is left as a template because your initial data structure doesn't include ZIP codes
//     $('#state_dropdown').change(function() {
//         // This would be similar to the states handling, but since we don't have ZIP codes in your data,
//         // you'd need to adjust based on your actual needs and data structure.
//     });
// });

</script>   
{% if user.is_authenticated %}
<script type="text/javascript">
    var userID = "{{ user.id }}"; // Injected securely from Django template
    var storageKey = 'selectedVariants-' + userID; // User-specific local storage key

    var selectedVariants = JSON.parse(localStorage.getItem(storageKey) || '[]');

    function updateVariantDetails() {
        var selector = document.getElementById('variantSelector');
        var selectedOption = selector.options[selector.selectedIndex];
        var imgSrc = selectedOption.getAttribute('data-img');
        var price = selectedOption.getAttribute('data-price');
        var variantId = selectedOption.value;

        document.getElementById('productImage').src = imgSrc;
        document.getElementById('productPrice').textContent = 'Price: ' + price;
    }

    function showNewButton() {
        document.getElementById('newButton').style.display = 'inline-block'; // Make the New Button visible
    }

    function displaySelectedVariantDetails() {
        var selector = document.getElementById('variantSelector');
        var selectedOption = selector.options[selector.selectedIndex];
        var imgSrc = selectedOption.getAttribute('data-img');
        var price = selectedOption.getAttribute('data-price');
        var variantId = selectedOption.value;

        var currentSelection = { variantId, imgSrc, price }; // Create object for the new selection
        selectedVariants.push(currentSelection); // Add to array

        localStorage.setItem(storageKey, JSON.stringify(selectedVariants)); // Update localStorage with user-specific key
        appendVariantToContainer(currentSelection, selectedVariants.length - 1); // Display the new selection
    }

    function appendVariantToContainer(variant, index) {
        var container = document.getElementById('selectedVariantsContainer');
        var variantDisplay = document.createElement('div');
        variantDisplay.setAttribute('id', `variant-${index}`);
        variantDisplay.innerHTML = `
            <img src="${variant.imgSrc}" alt="Variant Image" style="width: 50px; height: 50px;">
            <p>Price: ${variant.price}</p>
            <button onclick="deleteVariant(${index})">Delete</button>
        `;
        container.appendChild(variantDisplay);
    }

    function deleteVariant(index) {
        selectedVariants.splice(index, 1); // Remove variant
        localStorage.setItem(storageKey, JSON.stringify(selectedVariants)); // Update localStorage with user-specific key
        refreshVariantsDisplay(); // Refresh display
    }

    function refreshVariantsDisplay() {
        var container = document.getElementById('selectedVariantsContainer');
        container.innerHTML = ''; // Clear display
        selectedVariants.forEach((variant, index) => {
            appendVariantToContainer(variant, index); // Re-append each variant
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        refreshVariantsDisplay();
    });
</script>
{% endif %}


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

</body>
</html>